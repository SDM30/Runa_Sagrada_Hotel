<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta
      name="description"
      content="Runa Sagrada - Gestión de Habitaciones y Tipos"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión de Habitaciones - Runa Sagrada</title>

    <!-- Bootstrap / Icons (same stack as your admin page) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
    />
    <link rel="stylesheet" th:href="@{/styles/styles.css}" />
    <link rel="stylesheet" th:href="@{/styles/styles1.css}" />

    <style>
      :root {
        --sidebar-w: 260px;
      }

      /* Sidebar fijo */
      .sidebar {
        position: fixed;
        inset: 0 auto 0 0;
        width: var(--sidebar-w);
        z-index: 1040;
        transform: translateX(0);
        transition: transform 0.25s ease;
        overflow: hidden; /* evita que brillos/blur tapen el contenido */
      }

      /* Compensa el sidebar y AJUSTA ANCHO (para que no se corte a la derecha) */
      .dashboard-header,
      main#content {
        margin-left: var(--sidebar-w);
        width: calc(100% - var(--sidebar-w)); /* <-- clave */
        box-sizing: border-box;
        padding: 24px; /* respiración lateral */
      }

      /* Backdrop, fuera del <aside> */
      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(1px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        z-index: 1030;
      }
      .sidebar.show + .sidebar-backdrop {
        opacity: 1;
        visibility: visible;
      }

      /* Móvil: off-canvas y ancho completo */
      @media (max-width: 991.98px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .dashboard-header,
        main#content {
          margin-left: 0;
          width: 100%;
          padding: 16px;
        }
        body.no-scroll {
          overflow: hidden;
        }
      }

      /* Badges completos y consistentes con el tema */
      .badge-glass {
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-weight: 600;
        display: inline-block;
      }
      .badge-glass.badge-success {
        background: #16a34a;
        color: #fff;
      } /* verde */
      .badge-glass.badge-warning {
        background: #f59e0b;
        color: #1f2937;
      } /* ámbar */
      .badge-glass.badge-danger {
        background: #ef4444;
        color: #fff;
      } /* rojo */
      .badge-glass.badge-info {
        background: #3b82f6;
        color: #fff;
      } /* azul */
      .badge-glass.badge-secondary {
        background: #6b7280;
        color: #fff;
      } /* gris */
    </style>
  </head>
  <body class="dashboard-container">
    <!-- Sidebar (kept simple, same vibe as adminPage) -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header p-3">
        <img
          th:src="@{/images/logito.png}"
          alt="Runa Sagrada"
          class="sidebar-logo"
          style="height: 42px"
        />
        <h2 class="sidebar-title h5 mt-2 mb-0">Admin Panel</h2>
      </div>
      <nav class="sidebar-nav nav flex-column px-2">
        <a
          class="sidebar-nav-link nav-link"
          th:href="@{/}"
          aria-selected="false"
        >
          <i class="fas fa-chart-pie me-2"></i> Dashboard
        </a>
        <a
          class="sidebar-nav-link nav-link active"
          href="#content"
          aria-selected="true"
        >
          <i class="fas fa-bed me-2"></i> Habitaciones & Tipos
        </a>
      </nav>
    </aside>
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Header -->
    <header class="dashboard-header p-4 border-bottom">
      <h1 class="dashboard-title display-5 mb-1">Panel de Administración</h1>
      <p class="dashboard-subtitle text-muted mb-0">
        Administra habitaciones, tipos y filtros de búsqueda
      </p>
    </header>

    <!-- Main Content -->
    <main id="content" class="container-fluid p-4">
      <!-- Alerts (flash) -->
      <div
        th:if="${msgSuccess}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <span th:text="${msgSuccess}">Operación exitosa.</span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Cerrar"
        ></button>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="rooms-tab"
            data-bs-toggle="tab"
            data-bs-target="#rooms-pane"
            type="button"
            role="tab"
            aria-controls="rooms-pane"
            aria-selected="true"
          >
            Habitaciones
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="types-tab"
            data-bs-toggle="tab"
            data-bs-target="#types-pane"
            type="button"
            role="tab"
            aria-controls="types-pane"
            aria-selected="false"
          >
            Tipos de Habitación
          </button>
        </li>
      </ul>

      <div class="tab-content pt-3">
        <!-- ===================== ROOMS ===================== -->
        <section
          class="tab-pane fade show active"
          id="rooms-pane"
          role="tabpanel"
          aria-labelledby="rooms-tab"
        >
          <div class="tabla-header">
            <h2 class="h5 mb-0">Habitaciones</h2>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary" id="btnRoomsReset">
                <i class="fas fa-rotate me-2"></i>Limpiar
              </button>
              <button
                class="btn btn-gradient"
                data-bs-toggle="modal"
                data-bs-target="#roomCreateModal"
              >
                <i class="fas fa-plus me-2"></i>Nueva Habitación
              </button>
            </div>
          </div>

          <!-- Search -->
          <form id="roomsSearchForm" class="row g-2 align-items-end search-row">
            <div class="col-md-auto">
              <label class="form-label mb-0">N° Habitación</label>
              <input
                type="text"
                class="form-control"
                id="roomNumber"
                placeholder="101 / 202A"
              />
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Piso</label>
              <input
                type="number"
                class="form-control"
                id="floorNumber"
                placeholder="1"
              />
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Reserva</label>
              <select class="form-select" id="resStatus">
                <option value="">(Todos)</option>
                <option
                  th:each="s : ${reservationStatuses}"
                  th:value="${s}"
                  th:text="${s}"
                ></option>
              </select>
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Limpieza</label>
              <select class="form-select" id="cleStatus">
                <option value="">(Todos)</option>
                <option
                  th:each="s : ${cleaningStatuses}"
                  th:value="${s}"
                  th:text="${s}"
                ></option>
              </select>
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Tema</label>
              <input
                type="text"
                class="form-control"
                id="themeName"
                placeholder="Colonial / Cafetero"
              />
            </div>
            <div class="col-md-auto">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Buscar
              </button>
            </div>
          </form>

          <!-- Results -->
          <div class="table-responsive mt-3">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Hotel</th>
                  <th>Tipo</th>
                  <th>Número</th>
                  <th>Piso</th>
                  <th>Reserva</th>
                  <th>Limpieza</th>
                  <th>Tema</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody id="roomsTbody">
                <tr class="text-muted">
                  <td colspan="9">
                    Usa los filtros y presiona <em>Buscar</em>…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- ===================== ROOM TYPES ===================== -->
        <section
          class="tab-pane fade"
          id="types-pane"
          role="tabpanel"
          aria-labelledby="types-tab"
        >
          <div class="tabla-header">
            <h2 class="h5 mb-0">Tipos de Habitación</h2>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary" id="btnTypesReset">
                <i class="fas fa-rotate me-2"></i>Limpiar
              </button>
              <button
                class="btn btn-gradient"
                data-bs-toggle="modal"
                data-bs-target="#typeCreateModal"
              >
                <i class="fas fa-plus me-2"></i>Nuevo Tipo
              </button>
            </div>
          </div>

          <!-- Search -->
          <form id="typesSearchForm" class="row g-2 align-items-end search-row">
            <div class="col-md-auto">
              <label class="form-label mb-0">Nombre</label>
              <input
                type="text"
                class="form-control"
                id="typeName"
                placeholder="Estándar / Suite"
              />
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Capacidad Mín</label>
              <input
                type="number"
                class="form-control"
                id="minCapacity"
                min="1"
                placeholder="1"
              />
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0">Capacidad Máx</label>
              <input
                type="number"
                class="form-control"
                id="maxCapacity"
                min="1"
                placeholder="6"
              />
            </div>
            <div class="col-md-auto">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Buscar
              </button>
            </div>
          </form>

          <!-- Results -->
          <div class="table-responsive mt-3">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Precio Base</th>
                  <th>Capacidad</th>
                  <th>Amenities</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody id="typesTbody">
                <tr class="text-muted">
                  <td colspan="6">
                    Usa los filtros y presiona <em>Buscar</em>…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
      <!-- /tab-content -->

      <!-- --------------- MODALS --------------- -->

      <!-- Create Room -->
      <div
        class="modal fade"
        id="roomCreateModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <form
            th:action="@{/rooms/staff/create}"
            method="post"
            th:object="${roomForm}"
            class="modal-content"
          >
            <div class="modal-header">
              <h5 class="modal-title">Nueva Habitación</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-4">
                <label class="form-label">Hotel ID</label>
                <input
                  th:field="*{hotelId}"
                  type="number"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-8">
                <label class="form-label">Tipo de Habitación</label>
                <select th:field="*{roomType.id}" class="form-select" required>
                  <option value="">Seleccionar…</option>
                  <option
                    th:each="rt : ${roomTypes}"
                    th:value="${rt.id}"
                    th:text="${rt.name}"
                  ></option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Número</label>
                <input
                  th:field="*{roomNumber}"
                  type="text"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Piso</label>
                <input
                  th:field="*{floorNumber}"
                  type="number"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Estado de Reserva</label>
                <select th:field="*{resStatus}" class="form-select" required>
                  <option
                    th:each="s : ${reservationStatuses}"
                    th:value="${s}"
                    th:text="${s}"
                  ></option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Estado de Limpieza</label>
                <select th:field="*{cleStatus}" class="form-select" required>
                  <option
                    th:each="s : ${cleaningStatuses}"
                    th:value="${s}"
                    th:text="${s}"
                  ></option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tema</label>
                <input
                  th:field="*{themeName}"
                  type="text"
                  class="form-control"
                />
              </div>
              <div class="col-12">
                <label class="form-label">Descripción del Tema</label>
                <textarea
                  th:field="*{themeDescription}"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button class="btn btn-primary" type="submit">Crear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Edit Room -->
      <div
        class="modal fade"
        id="roomEditModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <form id="roomEditForm" class="modal-content" method="post">
            <div class="modal-header">
              <h5 class="modal-title">Editar Habitación</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <!-- Same names as entity for binding -->
              <input type="hidden" id="roomEditId" />
              <div class="col-md-4">
                <label class="form-label">Hotel ID</label>
                <input
                  name="hotelId"
                  id="hotelIdEdit"
                  type="number"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-8">
                <label class="form-label">Tipo de Habitación</label>
                <select
                  name="roomType.id"
                  id="roomTypeIdEdit"
                  class="form-select"
                  required
                >
                  <option value="">Seleccionar…</option>
                  <option
                    th:each="rt : ${roomTypes}"
                    th:value="${rt.id}"
                    th:text="${rt.name}"
                  ></option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Número</label>
                <input
                  name="roomNumber"
                  id="roomNumberEdit"
                  type="text"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Piso</label>
                <input
                  name="floorNumber"
                  id="floorNumberEdit"
                  type="number"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Estado de Reserva</label>
                <select
                  name="resStatus"
                  id="resStatusEdit"
                  class="form-select"
                  required
                >
                  <option
                    th:each="s : ${reservationStatuses}"
                    th:value="${s}"
                    th:text="${s}"
                  ></option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Estado de Limpieza</label>
                <select
                  name="cleStatus"
                  id="cleStatusEdit"
                  class="form-select"
                  required
                >
                  <option
                    th:each="s : ${cleaningStatuses}"
                    th:value="${s}"
                    th:text="${s}"
                  ></option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Tema</label>
                <input
                  name="themeName"
                  id="themeNameEdit"
                  type="text"
                  class="form-control"
                />
              </div>
              <div class="col-12">
                <label class="form-label">Descripción del Tema</label>
                <textarea
                  name="themeDescription"
                  id="themeDescriptionEdit"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button class="btn btn-primary" type="submit">Guardar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Delete Room (simple) -->
      <form id="roomDeleteForm" method="post" class="d-none"></form>

      <!-- Create RoomType -->
      <div
        class="modal fade"
        id="typeCreateModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <form
            th:action="@{/roomtype/staff/create}"
            method="post"
            class="modal-content"
          >
            <div class="modal-header">
              <h5 class="modal-title">Nuevo Tipo de Habitación</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input name="name" type="text" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Capacidad Máxima</label>
                <input
                  name="maxOccupancy"
                  type="number"
                  min="1"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Precio Base</label>
                <input
                  name="basePrice"
                  type="number"
                  min="0"
                  step="100"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <input
                  name="amenities"
                  type="text"
                  class="form-control"
                  placeholder="WiFi, AC, ..."
                />
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <textarea
                  name="description"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button class="btn btn-primary" type="submit">Crear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Edit RoomType -->
      <div
        class="modal fade"
        id="typeEditModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <form id="typeEditForm" method="post" class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Editar Tipo</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Cerrar"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <input type="hidden" id="typeEditId" />
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input
                  name="name"
                  id="typeNameEdit"
                  type="text"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Capacidad Máxima</label>
                <input
                  name="maxOccupancy"
                  id="typeMaxOccEdit"
                  type="number"
                  min="1"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Precio Base</label>
                <input
                  name="basePrice"
                  id="typePriceEdit"
                  type="number"
                  min="0"
                  step="100"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-12">
                <label class="form-label">Amenities</label>
                <input
                  name="amenities"
                  id="typeAmenitiesEdit"
                  type="text"
                  class="form-control"
                />
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <textarea
                  name="description"
                  id="typeDescEdit"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button class="btn btn-primary" type="submit">Guardar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Delete RoomType (simple) -->
      <form id="typeDeleteForm" method="post" class="d-none"></form>
    </main>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      /* ---------- Config ---------- */
      const ROOMS_SEARCH_URL = "/rooms/staff/search-ajax";
      const ROOMS_GET_URL = (id) => `/rooms/staff/update/${id}`;
      const ROOMS_UPDATE_URL = (id) => `/rooms/staff/update/${id}`;
      const ROOMS_DELETE_URL = (id) => `/rooms/staff/delete/${id}`;

      const TYPES_SEARCH_URL = "/roomtype/staff/search-ajax";
      const TYPES_UPDATE_URL = (id) => `/roomtype/staff/update/${id}`;
      const TYPES_DELETE_URL = (id) => `/roomtype/staff/delete/${id}`;

      /* ---------- Helpers ---------- */
      function qs(id) {
        return document.getElementById(id);
      }
      function toParams(obj) {
        const p = new URLSearchParams();
        Object.entries(obj).forEach(([k, v]) => {
          if (v !== undefined && v !== null && String(v).trim() !== "")
            p.append(k, v);
        });
        return p.toString();
      }

      /* ---------- ROOMS ---------- */
      const roomsTbody = qs("roomsTbody");
      const roomsCache = new Map();

      function badgeByResStatus(s) {
        switch (String(s || "").toUpperCase()) {
          case "AVAILABLE":
            return "badge-success"; // verde
          case "BOOKED":
            return "badge-danger"; // rojo
          case "OCCUPIED":
            return "badge-info"; // azul
          case "MAINTENANCE":
            return "badge-secondary"; // gris
          default:
            return "badge-info";
        }
      }
      function badgeByCleanStatus(s) {
        switch (String(s || "").toUpperCase()) {
          case "CLEAN":
            return "badge-success"; // verde
          case "DIRTY":
            return "badge-warning"; // ámbar
          case "IN_PROGRESS":
            return "badge-secondary"; // gris
          default:
            return "badge-info";
        }
      }
      function renderRooms(rows) {
        const tbody = document.getElementById("roomsTbody");
        tbody.innerHTML = "";
        if (!rows || rows.length === 0) {
          tbody.innerHTML =
            '<tr class="text-muted"><td colspan="9">Sin resultados</td></tr>';
          return;
        }
        rows.forEach((r) => {
          const rtName = r.roomType?.name ?? r.roomTypeName ?? "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td><strong>#${r.id}</strong></td>
        <td>${r.hotelId ?? ""}</td>
        <td>${rtName}</td>
        <td>${r.roomNumber ?? ""}</td>
        <td>${r.floorNumber ?? ""}</td>
        <td><span class="badge-glass ${badgeByResStatus(r.resStatus)}">${
            r.resStatus ?? ""
          }</span></td>
        <td><span class="badge-glass ${badgeByCleanStatus(r.cleStatus)}">${
            r.cleStatus ?? ""
          }</span></td>
        <td>${r.themeName ?? ""}</td>
        <td class="table-actions">
          <div class="btn-group-glass">
            <button class="btn-glass btn-glass-primary" data-action="edit" data-id="${
              r.id
            }" title="Editar"><i class="fas fa-pen"></i></button>
            <button class="btn-glass btn-glass-danger"  data-action="del"  data-id="${
              r.id
            }" title="Eliminar"><i class="fas fa-trash"></i></button>
          </div>
        </td>`;
          tbody.appendChild(tr);
        });
      }

      async function searchRooms(e) {
        if (e) e.preventDefault();
        const params = toParams({
          roomNumber: qs("roomNumber").value,
          floorNumber: qs("floorNumber").value,
          resStatus: qs("resStatus").value,
          cleStatus: qs("cleStatus").value,
          themeName: qs("themeName").value,
        });
        const res = await fetch(`${ROOMS_SEARCH_URL}?${params}`);
        const data = await res.json();
        renderRooms(data);
      }
      qs("roomsSearchForm").addEventListener("submit", searchRooms);
      qs("btnRoomsReset").addEventListener("click", () => {
        [
          "roomNumber",
          "floorNumber",
          "resStatus",
          "cleStatus",
          "themeName",
        ].forEach((id) => (qs(id).value = ""));
        // Ahora, al limpiar, vuelve a mostrar TODO automáticamente
        searchRooms();
      });

      /* Edit Room (prefill) */
      const roomEditModal = document.getElementById("roomEditModal");
      roomsTbody.addEventListener("click", async (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.dataset.action === "edit") {
          const res = await fetch(ROOMS_GET_URL(id));
          const r = await res.json();
          qs("roomEditId").value = r.id;
          qs("hotelIdEdit").value = r.hotelId ?? "";
          qs("roomTypeIdEdit").value = r.roomType?.id ?? r.roomTypeId ?? "";
          qs("roomNumberEdit").value = r.roomNumber ?? "";
          qs("floorNumberEdit").value = r.floorNumber ?? "";
          qs("resStatusEdit").value = r.resStatus ?? "";
          qs("cleStatusEdit").value = r.cleStatus ?? "";
          qs("themeNameEdit").value = r.themeName ?? "";
          qs("themeDescriptionEdit").value = r.themeDescription ?? "";
          qs("roomEditForm").setAttribute("action", ROOMS_UPDATE_URL(id));
          bootstrap.Modal.getOrCreateInstance(roomEditModal).show();
        } else if (btn.dataset.action === "del") {
          if (confirm("¿Eliminar esta habitación?")) {
            const form = document.getElementById("roomDeleteForm");
            form.setAttribute("action", ROOMS_DELETE_URL(id));
            form.submit();
          }
        }
      });

      /* ---------- ROOM TYPES ---------- */
      const typesTbody = qs("typesTbody");
      const typesCache = new Map();

      function renderTypes(rows) {
        typesTbody.innerHTML = "";
        if (!rows || rows.length === 0) {
          typesTbody.innerHTML =
            '<tr class="text-muted"><td colspan="6">Sin resultados</td></tr>';
          return;
        }
        rows.forEach((t) => {
          typesCache.set(t.id, t);
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${t.id}</td>
      <td>${t.name ?? ""}</td>
      <td>$${Number(t.basePrice ?? 0).toLocaleString("es-CO")}</td>
      <td>${t.maxOccupancy ?? ""}</td>
      <td>${t.amenities ?? ""}</td>
      <td class="text-end table-actions">
        <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-id="${
          t.id
        }">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${
          t.id
        }">
          <i class="fas fa-trash"></i>
        </button>
      </td>`;
          typesTbody.appendChild(tr);
        });
      }

      async function searchTypes(e) {
        if (e) e.preventDefault();
        const params = toParams({
          name: qs("typeName").value,
          minCapacity: qs("minCapacity").value,
          maxCapacity: qs("maxCapacity").value,
        });
        const res = await fetch(`${TYPES_SEARCH_URL}?${params}`);
        const data = await res.json();
        renderTypes(data);
      }
      qs("typesSearchForm").addEventListener("submit", searchTypes);
      qs("btnTypesReset").addEventListener("click", () => {
        ["typeName", "minCapacity", "maxCapacity"].forEach(
          (id) => (qs(id).value = "")
        );
        // Al limpiar, vuelve a mostrar TODOS los tipos
        searchTypes();
      });

      /* Edit Type (prefill from cache) */
      const typeEditModal = document.getElementById("typeEditModal");
      typesTbody.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button");
        if (!btn) return;
        const id = btn.dataset.id;
        if (btn.dataset.action === "edit") {
          const t = typesCache.get(Number(id));
          if (!t) return;
          qs("typeEditId").value = t.id;
          qs("typeNameEdit").value = t.name ?? "";
          qs("typeMaxOccEdit").value = t.maxOccupancy ?? "";
          qs("typePriceEdit").value = t.basePrice ?? "";
          qs("typeAmenitiesEdit").value = t.amenities ?? "";
          qs("typeDescEdit").value = t.description ?? "";
          qs("typeEditForm").setAttribute("action", TYPES_UPDATE_URL(id));
          bootstrap.Modal.getOrCreateInstance(typeEditModal).show();
        } else if (btn.dataset.action === "del") {
          if (confirm("¿Eliminar este tipo?")) {
            const form = document.getElementById("typeDeleteForm");
            form.setAttribute("action", TYPES_DELETE_URL(id));
            form.submit();
          }
        }
      });

      /* ---------- AUTO-CARGA INICIAL ---------- */
      /* Al cargar la página, trae TODOS los elementos de ambos listados,
   aprovechando que el backend retorna “todo” cuando los filtros van vacíos. */
      window.addEventListener("DOMContentLoaded", () => {
        searchRooms(); // lista de Habitaciones
        searchTypes(); // lista de Tipos
      });
      // --- Sidebar mobile toggle ---
      const sb = document.getElementById("sidebar");
      const sbb = document.getElementById("sidebarBackdrop");
      const btn = document.getElementById("sidebarToggle"); // tu botón hamburguesa

      function openSidebar(open) {
        sb.classList.toggle("show", !!open);
        sbb.classList.toggle("show", !!open);
        document.body.classList.toggle("no-scroll", !!open);
      }

      btn?.addEventListener("click", () =>
        openSidebar(!sb.classList.contains("show"))
      );
      sbb?.addEventListener("click", () => openSidebar(false));
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 992) openSidebar(false);
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") openSidebar(false);
      });
    </script>
  </body>
</html>
